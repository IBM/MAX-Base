language: python
python:
  - 3.6

os:
  - linux
  - linux-ppc64le

dist: xenial

services:
  - docker

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "linux-ppc64le" ]]; then
       ARCH=ppc64le;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
       ARCH=x86_64;
    fi
  - mkdir -p ~/.docker
  - echo '{"experimental":"enabled"}' | tee ~/.docker/config.json 
  - sudo service docker restart

install:
  - docker build -f Dockerfile.pai -t "$REPO"/max-base-powerai:"$ARCH"-latest .

before_script:
  - docker run -it --rm -d -p 5000:5000 "$REPO"/max-base-powerai:"$ARCH"-latest
  - sleep 10

script:
  - docker ps | grep max-base-powerai

after_success:
  - docker login -u "$REPO_USER" -p "$REPO_PASS"
  - docker push "$REPO"/max-base-powerai:"$ARCH"-latest
  - docker pull "$REPO"/max-base-powerai:ppc64le-latest
  - docker pull "$REPO"/max-base-powerai:x86_64-latest
  - docker manifest create "$REPO"/max-base-powerai:latest "$REPO"/max-base-powerai:ppc64le-latest "$REPO"/max-base-powerai:x86_64-latest
  - docker manifest push "$REPO"/max-base-powerai:latest
